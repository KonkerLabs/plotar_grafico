<html>
  <head>
    <link href="./css/c30.css" rel="stylesheet" type="text/css">


    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="./bower_components/c3/c3.js"></script>
     <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script type="text/javascript">

      //função do javascript que é chamada no carregamento da página
      window.onload = function () {

      // Dado este ponto de conexão informado na plataforma:
      // https://api.demo.konkerlabs.net:443/sub/fsoh2687ru3m/{canal}
      // Fiz um roteamento na plataforma e o canal de saida que configurei é /out
      // O usuário deste gerado pela plataforma foi: fsoh2687ru3m
      // A senha gerada foi: SENHA_DO_DEVICE
      // Então a chamada GET pode ser feita da seguinte forma:
      /*
      $.ajax({
          url: "https://fsoh2687ru3m:SENHA_DO_DEVICE@api.demo.konkerlabs.net/sub/fsoh2687ru3m/out",
          type: 'GET',
          dataType: 'jsonp',
          success:function(data) {
          }
      });*/

      ///
      //AQUI NESTE EXEMEPLO FIZ UMA FUNÇÃO EM QUE PLOTA UM GRÁFICO QUE SE ATUALIZA SOZINHO
      //Valores a serem passados para esta função:
      //variáveis de configuração de conexão com a plataforma KONKER
      //e configuração do gráfico a ser plotado
      var refreshInterval=1000; //de quanto em quanto tempo o ajax deve consultar novamente a plataforma em milissegundos
      var API_URI="api.demo.konkerlabs.net";//domínio do servidor api da konker
      var API_USER="fsoh2687ru3m";//usuário do device
      var API_PASS="SENHA_DO_DEVICE";//senha do device
      var API_CHANNEL="out";//canal de subscrição
      var chart_bindToId="chartContainer";//id da <div> em que o gráfico será plotado
      var chart_XData="meta[timestamp]";//item do json correspondente aos dados do eixo X
      var chart_XLabel="Tempo";//nome do eixo X
      var chart_YData="data[temperatura]";//item do json correspondente aos dados do eixo Y
      var chart_YLabel="Temperatura °C";//nome do eixo Y
      var chart_LineName="Temperatura";//nome da linha plotada
      var chart_Xformat="%H:%M:%S";//"%Y-%m-%d %H:%M:%S"; //formato dos dados do eixo X
      var chart_TooltipUnit="°C"; //unidade mostrada no tooltip


      //função que plota um gráfico de linha no tempo
      plotKonkerTimeseriesChart(refreshInterval,
        API_URI,
        API_USER,
        API_PASS,
        API_CHANNEL,
        chart_bindToId,
        chart_XData,
        chart_XLabel,
        chart_YData,
        chart_YLabel,
        chart_LineName,
        chart_TooltipUnit,
        chart_Xformat)



    }



////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
/// IMPLEMENTAÇÃO DA FUNÇÃO DE PLOTAGEM

    function plotKonkerTimeseriesChart(refreshInterval,
                            API_URI,
                            API_USER,
                            API_PASS,
                            API_CHANNEL,
                            chart_bindToId,
                            chart_XData,
                            chart_XLabel,
                            chart_YData,
                            chart_YLabel,
                            chart_LineName,
                            chart_TooltipUnit,
                            chart_Xformat) {
      var lastUpdate;
      var chart;

      //***
      //1o pego o timestamp do ultimo update
      $.ajax({
          url: "https://" + API_USER + ":" + API_PASS+ "@" + API_URI + "/sub/" + API_USER + "/" + API_CHANNEL,
          type: 'GET',
          dataType: 'jsonp',
          success:function(data) {
            lastUpdate=data[0].meta.timestamp;
            //***
            //2o ploto o gráfico com offset de 100segundos
            plotOffsetPoints(lastUpdate, 100)
          }
      });


      function plotOffsetPoints(lastUpdate, secondsOffset) {
        //faço um subscribe com offset de (lastUpdate - secondsOffset)
        $.ajax({
            url: "https://" + API_USER + ":" + API_PASS+ "@" + API_URI + "/sub/" + API_USER + "/" + API_CHANNEL + "?offset="+ String(lastUpdate - secondsOffset * 1000),
            dataType: 'jsonp',
            success:function(data) {
              var dataSliced = data.slice(0, 100);
              //plota o gráfico com o resultado do ajax
              plotPoints(dataSliced);
            }
        });
      }

      //PLOTAR UMA LINHA NO TEMPO DE UM ARRAY JSON
      function plotPoints(jsonarray) {
        //c3.js é uma biblioteca para plotar gráficos
        //veja a documentação do C3 em http://c3js.org/reference.html e exemplos em http://c3js.org/examples.html
        chart = c3.generate({
          transition: {
             duration: 200//tempo do efeito especial na hora de mostrar o gráfico
          },
          bindto: "#" + chart_bindToId,//indica qual o ID da div em que o gráfico deve ser desenhado
          zoom: {
            enabled: true //permite ou não o zoom no gráfico
          },

          data: {
            json:jsonarray,// dados json a serem plotados

            keys: {
              x: chart_XData,//item do json correspondente ao eixo X
              value: [chart_YData] ,//item do json correspondente ao eixo Y
            },
            names: {
              [chart_YData]: chart_LineName//nome da linha plotada
            }

          },
          axis: {
            x: {
              type : 'timeseries',//tipo do gráfico a ser plotado
              tick: {
                format: chart_Xformat,//formato dos dados no eixo X
                rotate: 45//rotação do texto dos dados no eixo X
              },
              label: {
                text: chart_XLabel,//nome do eixo X
                position: 'inner-middle'//posição do nome do eixo X
              }
            },

            y: {
              label: {
                text: chart_YLabel,//nome do eixo Y
                position: 'outer-middle'//posição do nome do eixo Y
              }
            }
          },

          tooltip: {
            show: true,
             format: {
               value: function (value, ratio, id, index) { return value + " " + chart_TooltipUnit; }
             }
          }
        });
      }


      //***
      //3o Chamada ciclica para a plataforma. A repetição é dada por refreshInterval
      setInterval(function(){
          $.ajax({

            url: "https://" + API_USER +  ":" + API_PASS +"@" + API_URI+ "/sub/" + API_USER +"/" + API_CHANNEL,
            type: 'GET',
            dataType: 'jsonp',
            success:function(data) {
              handleNewData(data);
            }
        })
      }, refreshInterval);



      function handleNewData(data){
        //só plota se o timestamp do ultimo dado retornado for diferente
        if (data[0].meta.timestamp != lastUpdate) {

          //flow é uma função do c3.js que adiciona pontos novos a um gráfico já existente
          chart.flow({
            json:data,
                keys: {
                  x: chart_XData, //dados do eixo X
                  value: [chart_YData] ,//dados do eixo Y
                },
                length: 1, //indica que a cada ponto novo, o mais antigo deve ser descartado
            duration: 200//tempo do efeito especial na hora de mostrar o gráfico
          });

        }
        //atualiza a variável lastUpdate
        lastUpdate=data[0].meta.timestamp;

        //CÓDIGO NECESSÁRIO PARA ATUALIZAR O GRÁFICO
        chart.resize();
      }

    }
    </script>







  </head>
  <body>
    <div id="data" style="width:100%; height:280px"></div>
    <div id="chartContainer" style="width:100%; height:280px"></div>

  </body>
</html>
